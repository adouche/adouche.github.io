<!DOCTYPE html>
<html>

<head>
    <meta property="article:published_time" content="2023-01-01T18:35:26.000Z" />
</head>

<body>
    <main>
        <article>
            <section>
                <div class="pw-post-title">
                    <h1>Non-boring routine updates</h1>
                </div>
                <p class="pw-post-body-paragraph">
                    I was doing routine software updates.
                </p>
                <p class="pw-post-body-paragraph">
                   The CI pipeline is really cool and convenient because, otherwise, how else would I have noticed that with the new libpcap the Wireshark build started to fail?
                </p>
                <p class="pw-post-body-paragraph">
                    It started failing with a very strange error message:
                </p>
                <p class="pw-post-body-paragraph">
                    "ninja: Entering directory `/ix/build/mcpe98eHnOfPdF2O/obj'
                    ninja: error: 
                    '/ix/store/iDo8RMwHvMz5h6hQ-lib-pcap/lib/libpcap.a;/ix/store/3KBy5KQKrWQR6EuF-lib-nl/lib/libnl-genl-3.a;/ix/store/
                    3KBy5KQKrWQR6EuF-lib-nl/lib/libnl-3.a', needed by 'run/tshark', 
                    missing and no known rule to make it"
                </p>
                <p class="pw-post-body-paragraph">
                    It says here that CMake generated an incorrect ninja file. Somewhere in the list of dependencies for some target, there is a strange 
                    string - 3 static libraries combined with `;`.
                </p>
                <p class="pw-post-body-paragraph">
                    Actually, it's pretty clear that CMake just writes some string there that it got from pkg-config, and something unexpected turned out to be there.
                </p>
                <p class="pw-post-body-paragraph">
                    Here is the diff in libpcap.pc of two different library versions:
                </p>
                <p class="pw-post-body-paragraph">
                    Name: libpcap
                     Description: Platform-independent network 
                        traffic capture library
                    +Version: 1.10.2
                    +Requires.private: libnl-genl-3.0 
                    +Libs: -L${libdir} -Wl,-rpath,${libdir} -lpcap
                    -Version: 1.10.1
                    -Libs: -L${libdir} -lpcap
                </p>                
                <p class="pw-post-body-paragraph">
                    The Requires.private field is what raised suspicion, of course 
                    <a href="https://people.freedesktop.org/~dbn/pkg-config-guide.html">https://people.freedesktop.org/~dbn/pkg-config-guide.html</a>.
                </p>
                <p class="pw-post-body-paragraph">
                    "Requires.private: A list of private packages required by this package but not exposed to applications. 
                    The version specific rules from the Requires field also apply here".
                </p>
                <p class="pw-post-body-paragraph">
                    The most convoluted explanation that, IMHO, explains nothing.
                </p>
                <p class="pw-post-body-paragraph">
                    I understand this as the beginnings of package management in pkg-config - a set of libraries that must be in the system 
                    (because they are needed by dependencies of some .so in the package).
                </p>
                <p class="pw-post-body-paragraph">
                    In the case of static libraries, we get just such strange nonsense, from all the absolute paths combined through “;”.
                </p>
                <p class="pw-post-body-paragraph">
                    I didn't bother to investigate who called or understood whom incorrectly because I already have information about transitive dependencies 
                    and don't need it duplicated in .pc files.
                </p>
                <p class="pw-post-body-paragraph">
                    During the process, I created an interesting artifact - a "package with prepared entropy". This is how I request that it be available at the time of keys 
                    preparation - <a href="https://github.com/pg83/ix/blob/main/pkgs/bin/dropbear/runit/hostkeys/ix.sh#L4">https://github.com/pg83/ix/blob/main/pkgs/bin/dropbear/runit/hostkeys/ix.sh#L4</a>,
                    and this is what its implementation looks like - 
                    <a href="https://github.com/pg83/ix/blob/main/pkgs/aux/entropy/ix.sh">https://github.com/pg83/ix/blob/main/pkgs/aux/entropy/ix.sh</a>,
                    <a href="https://github.com/pg83/ix/blob/main/pkgs/aux/entropy/ix.sh#L10">https://github.com/pg83/ix/blob/main/pkgs/aux/entropy/ix.sh#L10</a> 
                    - this is where all the pulp is, passing the seed to OpenSSL.                    
                </p>
                <p class="pw-post-body-paragraph">
                    pg-> ./ix build aux/entropy 
                      --entropy_seed="dead beef" 
                      --entropy_size=100
                    READY /ix/store/7aP.../touch
                    pg-> ls -ls /ix/store/7aP.../share/entropy
                         100 ... /ix/store/7aP.../share/entropy
                </p>
                <p class="pw-post-body-paragraph">
                    This artifact is quite useful because during system installation there are many processes that require generating a unique host identifier, 
                    such as /etc/machine-id, which is used in D-Bus.
                </p>
                <p class="pw-post-body-paragraph">
                    Overall, it is clear that are not making the process worse compared to how it was before - we used to "use entropy at the current moment in time 
                    as a seed to generate some files", and now we "save entropy at some point in time and use it to generate these same files again and again." 
                    That is, we store the seed, not the result of generation.
                </p>
                <p class="pw-post-body-paragraph">
                    By the way, I found something beautiful while reading the source code - 
                    <a href="https://github.com/mkj/dropbear/blob/master/dbrandom.c#L270">https://github.com/mkj/dropbear/blob/master/dbrandom.c#L270</a>.<br>
                    Here it is written how normal people gather initial entropy for work.                
                </p>
                <p class="pw-post-body-paragraph">
                    (Those who tried to blame me for this file 
                    <a href="https://github.com/catboost/catboost/blob/master/util/random/entropy.cpp#L40">https://github.com/catboost/catboost/blob/master/util/random/entropy.cpp#L40</a> 
                    should be ashamed - many do it this way!)                
                </p>
          </section>
        </article>
    </main>
</body>

</html>
